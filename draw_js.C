#include "TFile.h"
#include "TH1.h"
#include "TMath.h"

#include <vector>
#include <string>

// Photon pT > 60
std::vector<float> purity_pbpbdata_60 = {0.681689, 0.730339, 0.775276, 0.825922};
std::vector<float> purity_pbpbmc_60 = {0.922658, 0.957185, 0.973422, 0.982594};
std::vector<float> purity_ppdata_60 = {0.841322, 0.841322, 0.841322, 0.841322};
std::vector<float> purity_ppmc_60 = {0.984076, 0.984076, 0.984076, 0.984076};

// photon pT > 80
std::vector<float> purity_pbpbdata_80 = {0.685621, 0.751769, 0.787902, 0.816627};
std::vector<float> purity_pbpbmc_80 = {0.92439, 0.957436, 0.96544, 0.980661};
std::vector<float> purity_ppdata_80 = {0.853694, 0.853694, 0.853694, 0.853694};
std::vector<float> purity_ppmc_80 = {0.986312, 0.986312, 0.986312, 0.986312};

// Photon pT > 100
std::vector<float> purity_pbpbdata_100 = {0.700252, 0.792531, 0.821031, 0.797929};
std::vector<float> purity_pbpbmc_100 = {0.888486, 0.950618, 0.97097, 0.980991};
std::vector<float> purity_ppdata_100 = {0.851183, 0.851183, 0.851183, 0.851183};
std::vector<float> purity_ppmc_100 = {0.989016, 0.989016, 0.989016, 0.989016};

int min_hiBin[4] = {0, 20, 60, 100};
int max_hiBin[4] = {20, 60, 100, 200};

int draw_js(std::string sample, const char* type, const char* fname, const char* outfname, int phoetmin) {
    TFile* finput = new TFile(fname, "read");

    TFile* fout = new TFile(outfname, "update");

    TH1::SetDefaultSumw2();

    std::vector<float> purity_pbpbdata;
    std::vector<float> purity_pbpbmc;
    std::vector<float> purity_ppdata;
    std::vector<float> purity_ppmc;

    switch (phoetmin) {
        case 60:
            purity_pbpbdata = purity_pbpbdata_60;
            purity_pbpbmc = purity_pbpbmc_60;
            purity_ppdata = purity_ppdata_60;
            purity_ppmc = purity_ppmc_60;
            break;
        case 80:
            purity_pbpbdata = purity_pbpbdata_80;
            purity_pbpbmc = purity_pbpbmc_80;
            purity_ppdata = purity_ppdata_80;
            purity_ppmc = purity_ppmc_80;
            break;
        case 100:
            purity_pbpbdata = purity_pbpbdata_100;
            purity_pbpbmc = purity_pbpbmc_100;
            purity_ppdata = purity_ppdata_100;
            purity_ppmc = purity_ppmc_100;
            break;
        default:
            printf("no purity values available!\n");
            return 1;
    }

    float purity[4];
    for (int i=0; i<4; ++i) {
        if (sample == "pbpbmc")
            purity[i] = purity_pbpbmc[i];
        else if (sample == "pbpbdata")
            purity[i] = purity_pbpbdata[i];
        else if (sample == "ppdata")
            purity[i] = purity_ppdata[i];
        else if (sample == "ppmc")
            purity[i] = purity_ppmc[i];
    }

    TH1D* hjetpt[4] = {0};
    TH1D* hjetpt_mix[4] = {0};
    TH1D* hjetpt_sb[4] = {0};
    TH1D* hjetpt_mix_sb[4] = {0};

    TH1D* hjs[4] = {0};
    TH1D* hjs_ue[4] = {0};
    TH1D* hjs_jet[4] = {0};
    TH1D* hjs_jet_ue[4] = {0};
    TH1D* hjs_sb[4] = {0};
    TH1D* hjs_ue_sb[4] = {0};
    TH1D* hjs_jet_sb[4] = {0};
    TH1D* hjs_jet_ue_sb[4] = {0};

    TH1D* hjs_sub[4] = {0};
    TH1D* hjs_jet_sub[4] = {0};
    TH1D* hjs_sb_sub[4] = {0};
    TH1D* hjs_jet_sb_sub[4] = {0};

    TH1D* hjs_signal[4] = {0};
    TH1D* hjs_sideband[4] = {0};

    TH1D* hjs_final[4] = {0};

    for (int i=0; i<4; ++i) {
        std::string tag = Form("%s_%s_%i_%i", sample.c_str(), type, min_hiBin[i], max_hiBin[i]);

        hjetpt[i] = (TH1D*)finput->Get(Form("hjetpt_%s", tag.c_str()));
        hjetpt_mix[i] = (TH1D*)finput->Get(Form("hjetptjetmix_%s", tag.c_str()));
        hjetpt_sb[i] = (TH1D*)finput->Get(Form("hjetptsideband_%s", tag.c_str()));
        hjetpt_mix_sb[i] = (TH1D*)finput->Get(Form("hjetptjetmixsideband_%s", tag.c_str()));

        hjs[i] = (TH1D*)finput->Get(Form("hgammaffxi_%s", tag.c_str()));
        hjs_ue[i] = (TH1D*)finput->Get(Form("hgammaffxiuemix_%s", tag.c_str()));
        hjs_jet[i] = (TH1D*)finput->Get(Form("hgammaffxijetmix_%s", tag.c_str()));
        hjs_jet_ue[i] = (TH1D*)finput->Get(Form("hgammaffxijetmixue_%s", tag.c_str()));
        hjs_sb[i] = (TH1D*)finput->Get(Form("hgammaffxisideband_%s", tag.c_str()));
        hjs_ue_sb[i] = (TH1D*)finput->Get(Form("hgammaffxiuemixsideband_%s", tag.c_str()));
        hjs_jet_sb[i] = (TH1D*)finput->Get(Form("hgammaffxijetmixsideband_%s", tag.c_str()));
        hjs_jet_ue_sb[i] = (TH1D*)finput->Get(Form("hgammaffxijetmixuesideband_%s", tag.c_str()));

        hjs_sub[i] = (TH1D*)hjs[i]->Clone(Form("hjs_sub_%s", tag.c_str()));
        hjs_jet_sub[i] = (TH1D*)hjs_jet[i]->Clone(Form("hjs_jet_sub_%s", tag.c_str()));
        hjs_sb_sub[i] = (TH1D*)hjs_sb[i]->Clone(Form("hjs_sb_sub_%s", tag.c_str()));
        hjs_jet_sb_sub[i] = (TH1D*)hjs_jet_sb[i]->Clone(Form("hjs_jet_sb_sub_%s", tag.c_str()));

        hjs_sub[i]->Add(hjs_ue[i], -1);
        hjs_jet_sub[i]->Add(hjs_jet_ue[i], -1);
        hjs_sb_sub[i]->Add(hjs_ue_sb[i], -1);
        hjs_jet_sb_sub[i]->Add(hjs_jet_ue_sb[i], -1);

        hjs_signal[i] = (TH1D*)hjs_sub[i]->Clone(Form("hjs_signal_%s", tag.c_str()));
        hjs_sideband[i] = (TH1D*)hjs_sb_sub[i]->Clone(Form("hjs_sideband_%s", tag.c_str()));

        hjs_signal[i]->Add(hjs_jet_sub[i], -1);
        hjs_signal[i]->Scale(1.0/(hjetpt[i]->Integral() - hjetpt_mix[i]->Integral()));
        hjs_sideband[i]->Add(hjs_jet_sb_sub[i], -1);
        hjs_sideband[i]->Scale(1.0/(hjetpt_sb[i]->Integral() - hjetpt_mix_sb[i]->Integral()));

        hjs_final[i] = (TH1D*)hjs_signal[i]->Clone(Form("hjs_final_%s", tag.c_str()));

        hjs_final[i]->Scale(1.0/purity[i]);
        hjs_final[i]->Add(hjs_sideband[i], (purity[i] - 1.0)/purity[i]);

        hjs_final[i]->Scale(1/hjs_final[i]->Integral(hjs_final[i]->FindBin(0.01), hjs_final[i]->FindBin(0.29)), "width");

        hjs_final[i]->SetYTitle("#rho(r)");
    }

    fout->Write("", TObject::kOverwrite);
    fout->Close();

    return 0;
}

int main(int argc, char* argv[]) {
    if (argc > 5)
        for (int i=5; i<argc; ++i)
            draw_js(argv[1], argv[i], argv[2], argv[3], atoi(argv[4]));

    return 0;
}
